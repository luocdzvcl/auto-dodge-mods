-- Rivals Only!! | AUTO LEAVE WHEN STAFF DETECTED

xpcall(function()
    if game.GameId ~= 6035872082 then return end
    if shared.StaffDetectorLoading then return end
    shared.StaffDetectorLoading = true
    repeat task.wait() until game:IsLoaded()

    local players = game:GetService("Players")
    local http = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local lp = players.LocalPlayer
    local groupId = game.CreatorId

    if game.CreatorType ~= Enum.CreatorType.Group then return end

    local notify_sound
    task.spawn(function()
        if not isfile("AntiLua/staffdetect.mp3") then
            writefile("AntiLua/staffdetect.mp3",
                tostring(game:HttpGetAsync(
                    "https://github.com/Ukrubojvo/api/raw/main/ap-disconnect-boeing.mp3"
                ))
            )
        end
        notify_sound = Instance.new("Sound", workspace)
        notify_sound.SoundId = getcustomasset("AntiLua/staffdetect.mp3")
        notify_sound.Volume = 5
        notify_sound.Looped = false
    end)

    local function fetchURL(url)
        local ok, res = pcall(game.HttpGet, game, url)
        if ok then
            return http:JSONDecode(res)
        end
    end

    local function extractStaffRoleIds(groupId)
        local data = fetchURL(
            ("https://groups.roblox.com/v1/groups/%d/roles"):format(groupId)
        )
        local roleIds = {}
        if data and data.roles then
            for _, r in ipairs(data.roles) do
                local n = string.lower(r.name)
                if n:find("mod") or n:find("staff") or n:find("admin")
                or n:find("contributor") or n:find("script") or n:find("build") then
                    table.insert(roleIds, r.id)
                end
            end
        end
        return roleIds
    end

    local function fetchUsersInRole(groupId, roleId)
        local cursor = ""
        local collected = {}
        while true do
            local url = string.format(
                "https://groups.roproxy.com/v1/groups/%d/roles/%d/users?limit=100&cursor=%s",
                groupId, roleId, cursor
            )
            local ok, res = pcall(game.HttpGet, game, url)
            if not ok then break end
            local json = http:JSONDecode(res)
            for _, u in ipairs(json.data or {}) do
                collected[u.userId] = true
            end
            if not json.nextPageCursor then break end
            cursor = json.nextPageCursor
        end
        return collected
    end

    local staffRoleIds = extractStaffRoleIds(groupId)
    local staffUserIds = {}

    for _, rid in ipairs(staffRoleIds) do
        for uid in pairs(fetchUsersInRole(groupId, rid)) do
            staffUserIds[uid] = true
        end
    end

    local function isStaff(plr)
        local role = plr:GetRoleInGroup(groupId)
        if role then
            local r = role:lower()
            return r:find("mod") or r:find("staff") or r:find("admin")
                or r:find("contributor") or r:find("script") or r:find("build")
        end
        return false
    end

    local function friendIsStaff(plr)
        local ok, pages = pcall(players.GetFriendsAsync, players, plr.UserId)
        if not ok then return false end
        while true do
            for _, f in ipairs(pages:GetCurrentPage()) do
                if staffUserIds[f.Id] then
                    return true
                end
            end
            if pages.IsFinished then break end
            pages:AdvanceToNextPageAsync()
        end
        return false
    end

    local function AUTO_LEAVE()
        if notify_sound then notify_sound:Play() end
        task.wait(0.3)
        TeleportService:Teleport(17625359962)
    end

    -- CHECK CURRENT SERVER
    for _, plr in ipairs(players:GetPlayers()) do
        if isStaff(plr) or friendIsStaff(plr) then
            AUTO_LEAVE()
            return
        end
    end

    -- CHECK WHEN NEW PLAYER JOINS
    players.PlayerAdded:Connect(function(plr)
        plr.CharacterAdded:Wait()
        if isStaff(plr) or friendIsStaff(plr) then
            AUTO_LEAVE()
        end
    end)

end, function() end)
