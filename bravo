-- Rivals Only!! | AUTO LEAVE WHEN STAFF OR STAFF-FRIEND DETECTED

xpcall(function()
    if game.GameId ~= 6035872082 then return end
    if shared.StaffDetectorLoading then return end
    shared.StaffDetectorLoading = true
    repeat task.wait() until game:IsLoaded()

    local Players = game:GetService("Players")
    local HttpService = game:GetService("HttpService")
    local TeleportService = game:GetService("TeleportService")
    local LocalPlayer = Players.LocalPlayer
    local GroupId = game.CreatorId

    if game.CreatorType ~= Enum.CreatorType.Group then return end

    -- Sound alert (optional)
    local notify_sound
    task.spawn(function()
        if not isfile("AntiLua/staffdetect.mp3") then
            writefile(
                "AntiLua/staffdetect.mp3",
                tostring(game:HttpGetAsync(
                    "https://github.com/Ukrubojvo/api/raw/main/ap-disconnect-boeing.mp3"
                ))
            )
        end
        notify_sound = Instance.new("Sound", workspace)
        notify_sound.SoundId = getcustomasset("AntiLua/staffdetect.mp3")
        notify_sound.Volume = 5
        notify_sound.Looped = false
    end)

    -- Utils
    local function fetchURL(url)
        local ok, res = pcall(game.HttpGet, game, url)
        if ok and res then
            return HttpService:JSONDecode(res)
        end
    end

    -- Get staff role ids
    local function extractStaffRoleIds(groupId)
        local data = fetchURL(
            ("https://groups.roblox.com/v1/groups/%d/roles"):format(groupId)
        )
        local roleIds = {}
        if data and data.roles then
            for _, r in ipairs(data.roles) do
                local n = string.lower(r.name)
                if n:find("mod") or n:find("staff") or n:find("admin")
                or n:find("contributor") or n:find("script") or n:find("build") then
                    table.insert(roleIds, r.id)
                end
            end
        end
        return roleIds
    end

    -- Get users in a role
    local function fetchUsersInRole(groupId, roleId)
        local cursor = ""
        local collected = {}
        while true do
            local url = string.format(
                "https://groups.roproxy.com/v1/groups/%d/roles/%d/users?limit=100&cursor=%s",
                groupId, roleId, cursor
            )
            local ok, res = pcall(game.HttpGet, game, url)
            if not ok or not res then break end
            local json = HttpService:JSONDecode(res)
            for _, u in ipairs(json.data or {}) do
                if u.userId then
                    collected[u.userId] = true
                end
            end
            if not json.nextPageCursor or json.nextPageCursor == "" then break end
            cursor = json.nextPageCursor
        end
        return collected
    end

    -- Build staff userId list
    local staffRoleIds = extractStaffRoleIds(GroupId)
    local staffUserIds = {}

    for _, rid in ipairs(staffRoleIds) do
        local users = fetchUsersInRole(GroupId, rid)
        for uid in pairs(users) do
            staffUserIds[uid] = true
        end
    end

    -- Check if player is staff by role name
    local function isStaff(plr)
        local role = plr:GetRoleInGroup(GroupId)
        if role then
            local r = string.lower(role)
            return r:find("mod") or r:find("staff") or r:find("admin")
                or r:find("contributor") or r:find("script") or r:find("build")
        end
        return false
    end

    -- Check if player has staff friends
    local function friendIsStaff(plr)
        local ok, pages = pcall(Players.GetFriendsAsync, Players, plr.UserId)
        if not ok or not pages then return false end
        while true do
            for _, f in ipairs(pages:GetCurrentPage()) do
                if staffUserIds[f.Id] then
                    return true
                end
            end
            if pages.IsFinished then break end
            pages:AdvanceToNextPageAsync()
        end
        return false
    end

    -- AUTO LEAVE (KEEP THIS TELEPORT)
    local function AUTO_LEAVE()
        if notify_sound then
            notify_sound:Play()
        end
        task.wait(0.3)
        TeleportService:Teleport(17625359962)
    end

    -- Check existing players
    for _, plr in ipairs(Players:GetPlayers()) do
        if isStaff(plr) or friendIsStaff(plr) then
            AUTO_LEAVE()
            return
        end
    end

    -- Check new players joining
    Players.PlayerAdded:Connect(function(plr)
        plr.CharacterAdded:Wait()
        if isStaff(plr) or friendIsStaff(plr) then
            AUTO_LEAVE()
        end
    end)

end, function() end)
